require 'rails_helper'
require_relative '../../../lib/certificate_wrapper'
require_relative '../../../lib/certificate_wrapper/certificate_wrapper'
require_relative '../../../lib/services/get_keys'

describe CertificateWrapper do
  describe "#generate_certificate" do
    it "generates a certificate for a good csr" do
      csr = "MTcwMTM3MDA3MSBURVNURSBkbyBDRVJUSUZJQ0FURQAyMDE0MTEyMjE0NDUwMACc0j3+fURQ/VNY0L3U51MD8Wxb/fEsk8pn60F+u1BWWCOTVqDXpp0q/m7o01U71kaoMUOZXtdjxcKkQ331mdUYhgmOJcOnjrlE5dhVmn7PKAAAANemO47F3zH9MG9xK5x7D7MAAQB2X9uTwfcTIQGbesavpd2BAQEA8Dhx/mG/2KtZPNgJGjpR9QIBAAJfT8mquNS4PrinrwJQw3UDAQDK8agS1vM48Z9kS2zeT44BBAEAri/Kz43YdglEecrzngMitgUBALJGIv6v90uU10uABKkAVGcGAQDCsuR+Oeafhb/rWMCLHubzBwEAb2U65YOmJIwxNA8byH2PpQgBALZZRN3Db8yNDXJ82SeoOEMJAQDm/SWG/wqObEj+S//LfEYqerRTxxyeKfrE5ZKJvhTlwsYqT7nIbX+7im72D/uD5j06fJ4pguX1l5M0wU/KeQya1Lca/DP7USQfeb+O2WLxiLxHEZdFUSctTGgGT9K+tUoFEx+AhnPsxDYYZpgmsLXz8yJ6pRxaHvZ9LlIi/aBi2KbTqOLCpBVTEjKzvHIOC3bgZwNBIUFi/UACqQkn9v2BEn5kO+4WyP3C7OYfhQtL57Q9yje64ImbTLOe6VwsHVGXTK3lwP7Qmtms0gGGOh4ifbCBGepqLTDX6XY5426mPnhyIzlEUWJUZD0kqgDzLdl0hMOgb8UpoaH72Qmn5clBsdJKJYynGbsiSBl8Vb/JbZ1qd5VeSYMeL/IRPcXntsozZz9CUl2FoogxXF0KcRhEkj0neDGbAYF5TDUAQNOyQfSZtvxBe1NwAOXkBGefPLMetVYlsK+IJAoRcUojLYYHpYHgAhom7KWMvRKjX1RwDKXXlvcKtqZt7UC4/abasJMzp3g6ANKlEvUDa8WZ2MTPnd8LM1W9c3GM/vZw4N8Zu20c1NK4ZIr+mqKstqCaJiAhRAqzox8JLlIkJaeGCWNkVvOkT6KqoWbdX+7cSfKt80BAgVocdWvTmGSYN2Q24Bqx7LJFYlgnAc1w3Y3i8xBwIFEJBb6k/wWuOWbxu89x+HbzYuFBXCx5CRcK4UdT4EN3A5KGAXYPqt4K9mIjmu8ru9kP/VwrWnanMYTAVpNqHq/vs9VEbb8V5IwiKJrL0O7wz6UACxZxSEg6BRbMaRIZckKuLG90NCMl04skarDai3hqfY3zgh3oh0BL94x18L85H7p30/DWg8GdH9kiIXKvK6TLJcAC0ZKFGpU17kgfjlkUT/Je81hodHn0K2b/a2Vsu74OVusMdFHcyZEYXtyDCCjJIjVO5Fx6Xo3A+YxG+sBqUddxQ6tSneIVKd+pXR8jlPowIH4blT4GRdQrYtfhZvcgRobmt3V7/2UDDsSN7ISfeW3QxUAyWRUc0M4NT4Gogdz6mOgr60Z5eKkJHNzVJS6q5tYj5f4frOHCmh4GJT2soEHtFON9w2I3qAGnqnEDurWqimg+6y7pHGSwhNVXq6IckQ6EI4QHg08DHW0rlQpnz9kJtZ2z11m7t8VcYS1fjFLV+QBsi03T05WhUH2rXpMpGBNo6hfXZXydL0UHeCGskadlMncOcuO9niAugYTVMWUu+JY8jv/A0xoAO+PyXeTD6ZXv2fwBVjOk4/is1VB/fG3kD7Fo0TufMUDqNMIzjv5FL04r2wiyHttf6JX8t5yJbsV9jK1uBolU/KkOjjM27np17dE+yzsJ1JHZS/vra+flz6e3O7Gn8FgUjwfOeChAKf1tnt/Ya+KlVDuln0UCQi6KqGNLw5CreR+Qn733R8LPbCFCdbuu5Up4U+GcqxW4Y4L7OkX+FBP6393s7sxtXpCywg6Ph442gXm7hXo="
      expect( CertificateWrapper.generate_certificate(csr, CertificateWrapper.valid, CertificateWrapper.ca_skey).length).to be > 0
    end
    it "doesnt generate a certificate for a bad csr" do
      csr = "mTcwMTM3MDA3MSBURVNURSBkbyBDRVJUSUZJQ0FURQAyMDE0MTEyMjE0NDUwMACc0j3+fURQ/VNY0L3U51MD8Wxb/fEsk8pn60F+u1BWWCOTVqDXpp0q/m7o01U71kaoMUOZXtdjxcKkQ331mdUYhgmOJcOnjrlE5dhVmn7PKAAAANemO47F3zH9MG9xK5x7D7MAAQB2X9uTwfcTIQGbesavpd2BAQEA8Dhx/mG/2KtZPNgJGjpR9QIBAAJfT8mquNS4PrinrwJQw3UDAQDK8agS1vM48Z9kS2zeT44BBAEAri/Kz43YdglEecrzngMitgUBALJGIv6v90uU10uABKkAVGcGAQDCsuR+Oeafhb/rWMCLHubzBwEAb2U65YOmJIwxNA8byH2PpQgBALZZRN3Db8yNDXJ82SeoOEMJAQDm/SWG/wqObEj+S//LfEYqerRTxxyeKfrE5ZKJvhTlwsYqT7nIbX+7im72D/uD5j06fJ4pguX1l5M0wU/KeQya1Lca/DP7USQfeb+O2WLxiLxHEZdFUSctTGgGT9K+tUoFEx+AhnPsxDYYZpgmsLXz8yJ6pRxaHvZ9LlIi/aBi2KbTqOLCpBVTEjKzvHIOC3bgZwNBIUFi/UACqQkn9v2BEn5kO+4WyP3C7OYfhQtL57Q9yje64ImbTLOe6VwsHVGXTK3lwP7Qmtms0gGGOh4ifbCBGepqLTDX6XY5426mPnhyIzlEUWJUZD0kqgDzLdl0hMOgb8UpoaH72Qmn5clBsdJKJYynGbsiSBl8Vb/JbZ1qd5VeSYMeL/IRPcXntsozZz9CUl2FoogxXF0KcRhEkj0neDGbAYF5TDUAQNOyQfSZtvxBe1NwAOXkBGefPLMetVYlsK+IJAoRcUojLYYHpYHgAhom7KWMvRKjX1RwDKXXlvcKtqZt7UC4/abasJMzp3g6ANKlEvUDa8WZ2MTPnd8LM1W9c3GM/vZw4N8Zu20c1NK4ZIr+mqKstqCaJiAhRAqzox8JLlIkJaeGCWNkVvOkT6KqoWbdX+7cSfKt80BAgVocdWvTmGSYN2Q24Bqx7LJFYlgnAc1w3Y3i8xBwIFEJBb6k/wWuOWbxu89x+HbzYuFBXCx5CRcK4UdT4EN3A5KGAXYPqt4K9mIjmu8ru9kP/VwrWnanMYTAVpNqHq/vs9VEbb8V5IwiKJrL0O7wz6UACxZxSEg6BRbMaRIZckKuLG90NCMl04skarDai3hqfY3zgh3oh0BL94x18L85H7p30/DWg8GdH9kiIXKvK6TLJcAC0ZKFGpU17kgfjlkUT/Je81hodHn0K2b/a2Vsu74OVusMdFHcyZEYXtyDCCjJIjVO5Fx6Xo3A+YxG+sBqUddxQ6tSneIVKd+pXR8jlPowIH4blT4GRdQrYtfhZvcgRobmt3V7/2UDDsSN7ISfeW3QxUAyWRUc0M4NT4Gogdz6mOgr60Z5eKkJHNzVJS6q5tYj5f4frOHCmh4GJT2soEHtFON9w2I3qAGnqnEDurWqimg+6y7pHGSwhNVXq6IckQ6EI4QHg08DHW0rlQpnz9kJtZ2z11m7t8VcYS1fjFLV+QBsi03T05WhUH2rXpMpGBNo6hfXZXydL0UHeCGskadlMncOcuO9niAugYTVMWUu+JY8jv/A0xoAO+PyXeTD6ZXv2fwBVjOk4/is1VB/fG3kD7Fo0TufMUDqNMIzjv5FL04r2wiyHttf6JX8t5yJbsV9jK1uBolU/KkOjjM27np17dE+yzsJ1JHZS/vra+flz6e3O7Gn8FgUjwfOeChAKf1tnt/Ya+KlVDuln0UCQi6KqGNLw5CreR+Qn733R8LPbCFCdbuu5Up4U+GcqxW4Y4L7OkX+FBP6393s7sxtXpCywg6Ph442gXm7hXo="
      expect( CertificateWrapper.generate_certificate(csr, CertificateWrapper.valid, CertificateWrapper.ca_skey).length).to be > 0
    end
  end
  describe "#ecdsa_keygen" do
    it "generates the pair of ecdsa keys [skey, pkey]" do
      expect(CertificateWrapper.ecdsa_keygen().size).to eq 2
    end
  end
  describe "#ntru_keygen" do
    it "generates the pair of ntru keys [skey, pkey]" do
      expect(CertificateWrapper.ntru_keygen().size).to eq 2
    end
  end
  describe "#ntru_encrypt and #ntru_decrypt" do
    it "generates an encrypted text and decrypts to Msg teste" do
      encrypted_response = CertificateWrapper.ntru_encrypt(CertificateWrapper.ntru_pkey, "Msg teste")
      expect(encrypted_response.size).to be > 0
      decrypted_response = CertificateWrapper.ntru_decrypt(CertificateWrapper.ntru_skey, encrypted_response)
      expect(decrypted_response).to eq 'Msg teste'
    end
  end
  describe "#get_csr_pkey" do
    it "gets pkey from a csr" do
      csr = "MyBnYXRld2F5ADIwMTQxMjA4MDMzOTUzADExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTExMQqem/dN+1Pr6sIvsqlsVHGtAAAAYxsroGhfYH2ISUibEDDfbwABAH1dO9pOzNbYdU1K8UZ7L3EBAQBKrByeVAGtuVDBg3R8IKmZAgEAzkhaTk0OXk0pPdBQgIyX2QMBAKge38rQDSvHFml/lPmaJc4EAQDGkh/YuKrq69FrLPPe2KEIBQEAo0b6UpTRv0yj++WdXZBLOAYBACAb1pMTj982SgsP2bVmzDEHAQDOIwSWSGbG4+Okqiqv06uECAEAUQ0x320eG6+QFU7yBJuCLQkBAGlPx0N04TEN0av29kySHXDjI6b9/SV8QLB+CUHitCzFnHUQyzVPnNT1A979JADlPJgBJplF24rQ8Vbi9WcCpa9Glyo6EicgdgwO6adO2hK+g2jIZy/YzR/sOsiw088LA6blP7NO5Pgxwgqo1nH+CWLdWBxu0B5bCRnV1o65rKEirby2gAqNldlA4G49UcY6ghOTeXRiB+kuMhmHYZZQdz5SNCDY/DxAhRVRTWGSGMMVBtloeF+V9ODaAU8a94BzIJqhNvPwCOfb5Xv/4+lpVggkCby0FJfBIcNj7PO5GgbKgaFv0f3CLWH/76JO/T2iTnsf9wl2RExBcbWrW1yS5VESxLewzaByMkZ1HdeopUz6E+haRTxzUw0wcynh8Lboyc7CBnbRiEFnMY+4oZdEy+Mv8yVEn/nVrNtymmhgWTo8w7/CiyzJ5DZqivuFHXcQbrosQB0iSFKexEhfnQKGP4mMpiQMNe0AATVlpZw62FDYRvf/bGsHGFcQBb9MB3+SWrGRhRLKA19gXLcHpTErRc4gLXUPlNRp1jndeCV41aWxOBp24Yu/4lh8aKwbjaQpB13/siVdQq07nk7Lkyq1qHp3w/1DKQ1Vv5027VLOKIhBAJ/Br+vn2R9qMUWw0ToJSj8gqAWfSCL//pBcV6OTR0MPIN5EVAMP2Iw1S/9vlrXVvFH44YBGLLYtdNBZ+Ypadq/3pr7ZXFGhAQUAiohC/NG4h5CtmBOjLqEM/skXhf2E9OP+UvyDBEdSU0UYNzpWYH72gyNLy8wpX4qe/10ieBZ3t+WWuUV6n8dPF1vo1xV/Bljq8gMGajZl/+vAScXWktedFol+Xe3YDUltpAsW1haoK6TSC0ESwqkVSNHanuEXeCcvdsTC48ftLsfYG8HabNkzOPxExGOiSuoy6GV/qmKcv1kWcw9ed7esZ8BVHXmLJG1cyd8JOuGtrDsSsPk34vOVCI9hLAvZDdj+PQo4eTPob8JAnSt5eQN6OPRCqboCqqHqvaU76PgKKBzbUYrD+2vGRWP6T+r+M/BPA7QmXCdeyDq4ivDIMl2o7L01d9JrtPWAwAxhqs9xy8Y6izaYAxzRLZLM+TqDRID+QS21IlhNDsoqXIYozKz48rzh8MBjDlF8ecvQmgUUv1ZeMMBE2BbbRkATokCR/4uaJu6ojJB7hLj3UymbzzgLR7QrjD8lQsmxw8y5Pe1wUTRYeh66EiPfmtQ2M/gGVlcnlMHy3CNHt8PeyqMnSwlVglt6MEXx5ZBB7lLj0OqkQv0rbCPgN3+x4e9ijKyPZ66am3F+ykuF6QpXsNDTDgq64x+yrPvALGMQovGoNoUivO2pjuKgxQZ3rAjcMLpKMYl87g9KVQKAqob7ImBEQej8QOQui11zvgwhQutZBnzwSPiah73p3X21e0EYGamcc6Y8GpAQx7Bl4fStc3BgiwlrDdnnTYPqRJSsETwnxfJxR7nuNHPvJQ=="
      pkey = CertificateWrapper.get_csr_pkey(csr)
      expect(pkey.length).to be > 0
    end
  end
end
